<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Lecture Vocal Multilingue - Sossou KouamÃ© Appolinaire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #064e3b 0%, #065f46 50%, #047857 100%);
            min-height: 100vh;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(10px);
        }
        
        .voice-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            background: linear-gradient(to right, #fbbf24, #f59e0b, #ea580c, #dc2626, #7c2d12);
            border-radius: 5px;
        }
        
        .voice-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: white;
            border: 4px solid #d97706;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .control-btn {
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            transform: translateY(-3px) scale(1.05);
        }
        
        .control-btn:active {
            transform: translateY(0) scale(0.95);
        }
        
        .wave-bar {
            width: 6px;
            background: linear-gradient(to top, #fbbf24, #d97706);
            border-radius: 3px;
            animation: wave 0.8s ease-in-out infinite;
        }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        .playing .wave-bar { animation-play-state: running; }
        .paused .wave-bar { animation-play-state: paused; }
        
        .drop-zone {
            border: 3px dashed #d97706;
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            transition: all 0.3s;
        }
        
        .drop-zone.drag-over {
            border-color: #92400e;
            background: #fde68a;
            transform: scale(1.02);
        }
        
        .word-span {
            transition: all 0.1s ease;
            padding: 2px 2px;
            border-radius: 4px;
        }
        
        .word-current {
            background: linear-gradient(120deg, #fbbf24 0%, #f59e0b 100%);
            color: #451a03;
            font-weight: 800;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.6);
            transform: scale(1.15);
            display: inline-block;
        }
        
        .word-read {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .lang-flag {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #d97706, #92400e);
            border-radius: 5px;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8 text-white">
            <div class="flex justify-center items-center gap-3 mb-2">
                <span class="bg-amber-500 text-amber-950 px-4 py-2 rounded-full font-bold text-sm">
                    ğŸŒ 10 LANGUES AFRICAINES & INTERNATIONALES
                </span>
            </div>
            <h1 class="text-4xl md:text-6xl font-bold mb-2">Web Lecture Vocal</h1>
            <p class="text-xl opacity-90">Par Sossou KouamÃ© Appolinaire</p>
            <p class="text-sm mt-2 opacity-75">ğŸ‡§ğŸ‡¯ BÃ©nin â€¢ ğŸ‡¨ğŸ‡® CÃ´te d'Ivoire â€¢ ğŸŒ Multilingue</p>
        </div>

        <!-- Main Panel -->
        <div class="glass-panel rounded-3xl shadow-2xl p-6 md:p-8 mb-6">
            
            <!-- File Upload -->
            <div id="dropZone" class="drop-zone rounded-2xl p-8 text-center mb-8 cursor-pointer">
                <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt" class="hidden">
                <div class="text-6xl mb-4">ğŸ“š</div>
                <p class="text-xl font-bold text-amber-900 mb-2">DÃ©posez votre document</p>
                <p class="text-amber-700">PDF, Word (.doc, .docx) ou TXT</p>
                <p id="fileName" class="mt-3 text-amber-600 font-bold hidden"></p>
            </div>

            <!-- Language Selection - 10 LANGUES -->
            <div class="mb-6 bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-6 border-2 border-amber-200">
                <label class="text-sm font-bold text-amber-900 uppercase tracking-wider mb-3 block">
                    ğŸŒ Choisissez votre Langue (10 disponibles)
                </label>
                
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <button class="lang-btn bg-white border-2 border-amber-300 rounded-xl p-3 hover:bg-amber-100 transition-all text-left focus:ring-4 focus:ring-amber-400 active" data-lang="fr-FR" data-name="FranÃ§ais" data-flag="ğŸ‡«ğŸ‡·">
                        <span class="lang-flag">ğŸ‡«ğŸ‡·</span>
                        <div class="font-bold text-amber-900">FranÃ§ais</div>
                        <div class="text-xs text-amber-700">France/Afrique</div>
                    </button>
                    
                    <button class="lang-btn bg-white border-2 border-amber-300 rounded-xl p-3 hover:bg-amber-100 transition-all text-left focus:ring-4 focus:ring-amber-400" data-lang="en-US" data-name="English" data-flag="ğŸ‡¬ğŸ‡§">
                        <span class="lang-flag">ğŸ‡¬ğŸ‡§</span>
                        <div class="font-bold text-amber-900">English</div>
                        <div class="text-xs text-amber-700">US/UK</div>
                    </button>
                    
                    <button class="lang-btn bg-white border-2 border-amber-300 rounded-xl p-3 hover:bg-amber-100 transition-all text-left focus:ring-4 focus:ring-amber-400" data-lang="es-ES" data-name="EspaÃ±ol" data-flag="ğŸ‡ªğŸ‡¸">
                        <span class="lang-flag">ğŸ‡ªğŸ‡¸</span>
                        <div class="font-bold text-amber-900">EspaÃ±ol</div>
                        <div class="text-xs text-amber-700">Espagne</div>
                    </button>
                    
                    <button class="lang-btn bg-white border-2 border-amber-300 rounded-xl p-3 hover:bg-amber-100 transition-all text-left focus:ring-4 focus:ring-amber-400" data-lang="pt-PT" data-name="PortuguÃªs" data-flag="ğŸ‡µğŸ‡¹">
                        <span class="lang-flag">ğŸ‡µğŸ‡¹</span>
                        <div class="font-bold text-amber-900">PortuguÃªs</div>
                        <div class="text-xs text-amber-700">Portugal/BrÃ©sil</div>
                    </button>
                    
                    <button class="lang-btn bg-white border-2 border-amber-300 rounded-xl p-3 hover:bg-amber-100 transition-all text-left focus:ring-4 focus:ring-amber-400" data-lang="ar-SA" data-name="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" data-flag="ğŸ‡¸ğŸ‡¦">
                        <span class="lang-flag">ğŸ‡¸ğŸ‡¦</span>
                        <div class="font-bold text-amber-900">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</div>
                        <div class="text-xs text-amber-700">Arabe</div>
                    </button>
                    
                    <button class="lang-btn bg-white border-2 border-amber-300 rounded-xl p-3 hover:bg-amber-100 transition-all text-left focus:ring-4 focus:ring-amber-400" data-lang="sw-KE" data-name="Kiswahili" data-flag="ğŸ‡°ğŸ‡ª">
                        <span class="lang-flag">ğŸ‡°ğŸ‡ª</span>
                        <div class="font-bold text-amber-900">Kiswahili</div>
                        <div class="text-xs text-amber-700">Afrique Est</div>
                    </button>
                    
                    <button class="lang-btn bg-white border-2 border-amber-300 rounded-xl p-3 hover:bg-amber-100 transition-all text-left focus:ring-4 focus:ring-amber-400" data-lang="ha-NG" data-name="Hausa" data-flag="ğŸ‡³ğŸ‡¬">
                        <span class="lang-flag">ğŸ‡³ğŸ‡¬</span>
                        <div class="font-bold text-amber-900">Hausa</div>
                        <div class="text-xs text-amber-700">Nigeria/Niger</div>
                    </button>
                    
                    <button class="lang-btn bg-white border-2 border-amber-300 rounded-xl p-3 hover:bg-amber-100 transition-all text-left focus:ring-4 focus:ring-amber-400" data-lang="yo-NG" data-name="YorÃ¹bÃ¡" data-flag="ğŸ‡³ğŸ‡¬">
                        <span class="lang-flag">ğŸ‡³ğŸ‡¬</span>
                        <div class="font-bold text-amber-900">YorÃ¹bÃ¡</div>
                        <div class="text-xs text-amber-700">Nigeria/BÃ©nin</div>
                    </button>
                    
                    <button class="lang-btn bg-white border-2 border-amber-300 rounded-xl p-3 hover:bg-amber-100 transition-all text-left focus:ring-4 focus:ring-amber-400" data-lang="ig-NG" data-name="Igbo" data-flag="ğŸ‡³ğŸ‡¬">
                        <span class="lang-flag">ğŸ‡³ğŸ‡¬</span>
                        <div class="font-bold text-amber-900">Igbo</div>
                        <div class="text-xs text-amber-700">Nigeria</div>
                    </button>
                    
                    <button class="lang-btn bg-white border-2 border-amber-300 rounded-xl p-3 hover:bg-amber-100 transition-all text-left focus:ring-4 focus:ring-amber-400" data-lang="zu-ZA" data-name="isiZulu" data-flag="ğŸ‡¿ğŸ‡¦">
                        <span class="lang-flag">ğŸ‡¿ğŸ‡¦</span>
                        <div class="font-bold text-amber-900">isiZulu</div>
                        <div class="text-xs text-amber-700">Afrique Sud</div>
                    </button>
                </div>
                
                <div class="mt-4 p-3 bg-amber-100 rounded-lg border border-amber-300">
                    <span class="text-amber-800 font-semibold">ğŸ¯ Langue sÃ©lectionnÃ©e : </span>
                    <span id="selectedLangDisplay" class="text-amber-900 font-bold text-lg">ğŸ‡«ğŸ‡· FranÃ§ais</span>
                </div>
            </div>

            <!-- Voice Type -->
            <div class="mb-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 border-2 border-green-200">
                <div class="flex justify-between items-center mb-4">
                    <label class="text-sm font-bold text-green-900 uppercase tracking-wider">ğŸ™ï¸ Type de Voix</label>
                    <span id="voiceLabel" class="bg-green-100 text-green-800 px-4 py-2 rounded-full font-bold border-2 border-green-300">
                        Femme Africaine
                    </span>
                </div>
                
                <input type="range" id="voiceSlider" min="0" max="100" value="40" class="voice-slider w-full mb-2">
                
                <div class="flex justify-between text-xs font-bold text-green-800 mt-3">
                    <span class="text-center">ğŸ‘¶<br>Enfant</span>
                    <span class="text-center">ğŸ§‘â€ğŸ¦±<br>Jeune</span>
                    <span class="text-center">ğŸ‘©<br>Femme</span>
                    <span class="text-center">ğŸ‘¨<br>Homme</span>
                    <span class="text-center">ğŸ§”<br>AÃ®nÃ©</span>
                </div>
            </div>

            <!-- Style & Speed -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                    <label class="text-sm font-bold text-blue-900 mb-2 block">ğŸ­ Style de lecture</label>
                    <select id="styleSelect" class="w-full bg-white border-2 border-blue-300 rounded-lg px-3 py-2 text-blue-900 font-semibold">
                        <option value="natural">ğŸŒ¿ Naturel</option>
                        <option value="warm" selected>ğŸ”¥ Chaleureux</option>
                        <option value="formal">ğŸ“œ Formel</option>
                        <option value="joyful">â˜€ï¸ Joyeux</option>
                        <option value="calm">ğŸƒ Calme</option>
                        <option value="story">ğŸ“– Conteur</option>
                    </select>
                </div>
                
                <div class="bg-purple-50 rounded-xl p-4 border-2 border-purple-200">
                    <label class="text-sm font-bold text-purple-900 mb-2 block">âš¡ Vitesse : <span id="rateValue" class="text-purple-700">0.9x</span></label>
                    <input type="range" id="rateSlider" min="0.5" max="1.5" step="0.1" value="0.9" class="w-full accent-purple-600">
                </div>
            </div>

            <!-- Visualizer -->
            <div class="flex justify-center mb-6">
                <div id="visualizer" class="flex items-center gap-1 h-10 opacity-30 paused">
                    <div class="wave-bar" style="height:20%;animation-delay:0s"></div>
                    <div class="wave-bar" style="height:40%;animation-delay:0.1s"></div>
                    <div class="wave-bar" style="height:60%;animation-delay:0.2s"></div>
                    <div class="wave-bar" style="height:40%;animation-delay:0.3s"></div>
                    <div class="wave-bar" style="height:20%;animation-delay:0.4s"></div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex justify-center gap-4 mb-6">
                <button id="playBtn" class="control-btn bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full p-5 shadow-xl disabled:opacity-50" disabled>
                    <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                
                <button id="pauseBtn" class="control-btn bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-full p-5 shadow-xl hidden">
                    <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                
                <button id="resumeBtn" class="control-btn bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-full p-5 shadow-xl hidden">
                    <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                
                <button id="stopBtn" class="control-btn bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-full p-5 shadow-xl disabled:opacity-50" disabled>
                    <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
                </button>
            </div>

            <!-- Progress -->
            <div class="bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl p-4 border-2 border-gray-200">
                <div class="flex justify-between text-sm font-bold text-gray-700 mb-2">
                    <span>Progression</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-green-500 via-amber-500 to-red-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-gray-600 font-mono">
                    <span id="currentTime">00:00</span>
                    <span id="totalTime">00:00</span>
                </div>
            </div>
        </div>

        <!-- Text Preview -->
        <div class="glass-panel rounded-3xl shadow-2xl p-6 md:p-8 border-2 border-amber-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-amber-900">ğŸ“– Texte avec suivi</h3>
                <div class="flex gap-2 text-xs">
                    <span class="bg-yellow-400 text-amber-900 px-2 py-1 rounded font-bold">En cours</span>
                    <span class="bg-amber-100 text-amber-800 px-2 py-1 rounded">Lu</span>
                </div>
            </div>
            
            <div id="textContainer" class="bg-white rounded-xl p-6 h-96 overflow-y-auto text-gray-900 text-lg leading-loose border-2 border-amber-200 shadow-inner">
                <div id="textPreview" class="whitespace-pre-wrap">
                    <div class="text-center text-gray-400 mt-20">
                        <div class="text-6xl mb-4">ğŸ“¥</div>
                        <p>Importez un document pour commencer...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-white/90 text-sm">
            <p class="text-lg font-semibold">Â© 2024 Sossou KouamÃ© Appolinaire</p>
            <p class="mt-2">ğŸŒ 10 Langues â€¢ ğŸ™ï¸ Voix Africaines â€¢ ğŸ“– Lecture intelligente</p>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // 10 LANGUES CONFIGURATION
        const languages = {
            'fr-FR': { name: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·', voices: ['fr-FR', 'fr-CA'] },
            'en-US': { name: 'English', flag: 'ğŸ‡¬ğŸ‡§', voices: ['en-US', 'en-GB', 'en-CA'] },
            'es-ES': { name: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸', voices: ['es-ES', 'es-MX', 'es-US'] },
            'pt-PT': { name: 'PortuguÃªs', flag: 'ğŸ‡µğŸ‡¹', voices: ['pt-PT', 'pt-BR'] },
            'ar-SA': { name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ğŸ‡¸ğŸ‡¦', voices: ['ar-SA', 'ar-EG'] },
            'sw-KE': { name: 'Kiswahili', flag: 'ğŸ‡°ğŸ‡ª', voices: ['sw-KE'] },
            'ha-NG': { name: 'Hausa', flag: 'ğŸ‡³ğŸ‡¬', voices: ['ha-NG'] },
            'yo-NG': { name: 'YorÃ¹bÃ¡', flag: 'ğŸ‡³ğŸ‡¬', voices: ['yo-NG'] },
            'ig-NG': { name: 'Igbo', flag: 'ğŸ‡³ğŸ‡¬', voices: ['ig-NG'] },
            'zu-ZA': { name: 'isiZulu', flag: 'ğŸ‡¿ğŸ‡¦', voices: ['zu-ZA'] }
        };

        let currentLang = 'fr-FR';
        let currentText = '';
        let words = [];
        let speechSynthesis = window.speechSynthesis;
        let isPaused = false;
        let isPlaying = false;
        let currentWordIndex = 0;
        let wordElements = [];

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const textPreview = document.getElementById('textPreview');
        const voiceSlider = document.getElementById('voiceSlider');
        const voiceLabel = document.getElementById('voiceLabel');
        const rateSlider = document.getElementById('rateSlider');
        const rateValue = document.getElementById('rateValue');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const visualizer = document.getElementById('visualizer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const selectedLangDisplay = document.getElementById('selectedLangDisplay');

        // Voice types
        const voiceTypes = [
            { label: 'ğŸ‘¶ Enfant', pitch: 1.6, rate: 1.0 },
            { label: 'ğŸ§‘â€ğŸ¦± Jeune', pitch: 1.1, rate: 0.95 },
            { label: 'ğŸ‘© Femme', pitch: 1.0, rate: 0.9 },
            { label: 'ğŸ‘¨ Homme', pitch: 0.85, rate: 0.88 },
            { label: 'ğŸ§” AÃ®nÃ©', pitch: 0.7, rate: 0.8 }
        ];

        // Language selection
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.lang-btn').forEach(b => {
                    b.classList.remove('ring-4', 'ring-amber-400', 'bg-amber-100');
                    b.classList.add('bg-white');
                });
                btn.classList.remove('bg-white');
                btn.classList.add('bg-amber-100', 'ring-4', 'ring-amber-400');
                
                currentLang = btn.dataset.lang;
                selectedLangDisplay.textContent = `${btn.dataset.flag} ${btn.dataset.name}`;
            });
        });

        // Events
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        voiceSlider.addEventListener('input', updateVoiceSettings);
        rateSlider.addEventListener('input', (e) => { rateValue.textContent = e.target.value + 'x'; });

        playBtn.addEventListener('click', startReading);
        pauseBtn.addEventListener('click', pauseReading);
        resumeBtn.addEventListener('click', resumeReading);
        stopBtn.addEventListener('click', stopReading);

        function updateVoiceSettings() {
            const value = parseInt(voiceSlider.value);
            const index = Math.floor((value / 100) * (voiceTypes.length - 1));
            voiceLabel.textContent = voiceTypes[index].label.replace(/ğŸ‘¶|ğŸ§‘â€ğŸ¦±|ğŸ‘©|ğŸ‘¨|ğŸ§” /, '');
        }

        async function handleFile(file) {
            fileName.textContent = 'ğŸ“„ ' + file.name;
            fileName.classList.remove('hidden');
            
            const ext = file.name.split('.').pop().toLowerCase();
            
            try {
                if (ext === 'pdf') await readPDF(file);
                else if (ext === 'doc' || ext === 'docx') await readWord(file);
                else if (ext === 'txt') await readTXT(file);
                else { alert('Format non supportÃ©'); return; }
                
                prepareText();
                enableControls();
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        }

        async function readPDF(file) {
            const buffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + ' ';
            }
            currentText = text.replace(/\s+/g, ' ').trim();
        }

        async function readWord(file) {
            const buffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: buffer });
            currentText = result.value.replace(/\s+/g, ' ').trim();
        }

        async function readTXT(file) {
            currentText = (await file.text()).replace(/\s+/g, ' ').trim();
        }

        function prepareText() {
            words = currentText.match(/[\wÃ€-Ã¿\u0600-\u06FF]+|[^\w\s]|\s+/g) || [];
            
            let html = '';
            wordElements = [];
            
            words.forEach((word, i) => {
                if (word.match(/^\s+$/)) {
                    html += word;
                } else {
                    html += `<span class="word-span" id="word-${i}">${escapeHtml(word)}</span>`;
                }
            });
            
            textPreview.innerHTML = html;
            
            words.forEach((_, i) => {
                const el = document.getElementById(`word-${i}`);
                if (el) wordElements[i] = el;
            });
            
            const mins = Math.ceil(words.length / 130);
            document.getElementById('totalTime').textContent = formatTime(mins * 60);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getVoiceConfig() {
            const value = parseInt(voiceSlider.value);
            const index = Math.floor((value / 100) * (voiceTypes.length - 1));
            const voice = voiceTypes[index];
            const style = document.getElementById('styleSelect').value;
            
            const styleMods = {
                natural: { p: 1, r: 1 },
                warm: { p: 1.05, r: 0.95 },
                formal: { p: 0.98, r: 0.9 },
                joyful: { p: 1.1, r: 1.05 },
                calm: { p: 0.95, r: 0.85 },
                story: { p: 1.02, r: 0.88 }
            };
            
            const mod = styleMods[style];
            
            return {
                pitch: voice.pitch * mod.p,
                rate: voice.rate * mod.r * parseFloat(rateSlider.value)
            };
        }

        function startReading() {
            if (!currentText || !words.length) return;
            
            stopReading();
            isPlaying = true;
            isPaused = false;
            currentWordIndex = 0;
            
            wordElements.forEach(el => el?.classList.remove('word-current', 'word-read'));
            
            playBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');
            resumeBtn.classList.add('hidden');
            visualizer.classList.remove('paused', 'opacity-30');
            visualizer.classList.add('playing');
            
            speakChunk();
        }

        function speakChunk() {
            if (!isPlaying || currentWordIndex >= words.length) {
                if (currentWordIndex >= words.length) stopReading();
                return;
            }
            
            const chunkSize = 5;
            const chunk = words.slice(currentWordIndex, currentWordIndex + chunkSize).join('');
            const actualWords = words.slice(currentWordIndex, currentWordIndex + chunkSize);
            
            const utterance = new SpeechSynthesisUtterance(chunk);
            const config = getVoiceConfig();
            
            utterance.lang = currentLang;
            utterance.pitch = config.pitch;
            utterance.rate = config.rate;
            
            // Find best voice
            const availableVoices = speechSynthesis.getVoices();
            const langPrefs = languages[currentLang].voices;
            
            let selectedVoice = null;
            for (let pref of langPrefs) {
                selectedVoice = availableVoices.find(v => v.lang.startsWith(pref));
                if (selectedVoice) break;
            }
            
            if (!selectedVoice) {
                selectedVoice = availableVoices.find(v => v.lang.startsWith(currentLang.split('-')[0]));
            }
            
            if (selectedVoice) utterance.voice = selectedVoice;
            
            // Word highlighting timing
            const charTime = (1000 / (config.rate * 5)); // ms per char approx
            let charCount = 0;
            const timers = [];
            
            actualWords.forEach((word, idx) => {
                if (!word.match(/^\s+$/)) {
                    const delay = charCount * charTime;
                    const timer = setTimeout(() => {
                        if (!isPlaying) return;
                        
                        const globalIdx = currentWordIndex + idx;
                        
                        if (globalIdx > 0 && wordElements[globalIdx - 1]) {
                            wordElements[globalIdx - 1].classList.remove('word-current');
                            wordElements[globalIdx - 1].classList.add('word-read');
                        }
                        
                        if (wordElements[globalIdx]) {
                            wordElements[globalIdx].classList.add('word-current');
                            wordElements[globalIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        updateProgress((globalIdx / words.length) * 100);
                        
                    }, delay);
                    timers.push(timer);
                }
                charCount += word.length + 1;
            });
            
            utterance.onend = () => {
                timers.forEach(t => clearTimeout(t));
                
                for (let i = currentWordIndex; i < currentWordIndex + chunkSize && i < words.length; i++) {
                    if (wordElements[i]) {
                        wordElements[i].classList.remove('word-current');
                        wordElements[i].classList.add('word-read');
                    }
                }
                
                currentWordIndex += chunkSize;
                
                if (isPlaying && !isPaused) {
                    setTimeout(speakChunk, 50);
                }
            };
            
            utterance.onerror = (e) => {
                if (e.error !== 'canceled') console.error(e);
                timers.forEach(t => clearTimeout(t));
            };
            
            speechSynthesis.speak(utterance);
            updateTime();
        }

        function updateTime() {
            if (!isPlaying) return;
            const elapsed = Math.floor((currentWordIndex / words.length) * parseTime(document.getElementById('totalTime').textContent));
            document.getElementById('currentTime').textContent = formatTime(elapsed);
            if (isPlaying) setTimeout(updateTime, 1000);
        }

        function parseTime(str) {
            const [m, s] = str.split(':').map(Number);
            return m * 60 + s;
        }

        function formatTime(sec) {
            return `${Math.floor(sec / 60).toString().padStart(2, '0')}:${(sec % 60).toString().padStart(2, '0')}`;
        }

        function pauseReading() {
            if (!isPaused) {
                speechSynthesis.pause();
                isPaused = true;
                pauseBtn.classList.add('hidden');
                resumeBtn.classList.remove('hidden');
                visualizer.classList.add('paused');
                visualizer.classList.remove('playing');
            }
        }

        function resumeReading() {
            if (isPaused) {
                speechSynthesis.resume();
                isPaused = false;
                resumeBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
                visualizer.classList.remove('paused');
                visualizer.classList.add('playing');
                updateTime();
            }
        }

        function stopReading() {
            speechSynthesis.cancel();
            isPlaying = false;
            isPaused = false;
            currentWordIndex = 0;
            
            playBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
            resumeBtn.classList.add('hidden');
            visualizer.classList.add('paused', 'opacity-30');
            visualizer.classList.remove('playing');
            
            wordElements.forEach(el => el?.classList.remove('word-current', 'word-read'));
            updateProgress(0);
            document.getElementById('currentTime').textContent = '00:00';
        }

        function enableControls() {
            playBtn.disabled = false;
            stopBtn.disabled = false;
        }

        function updateProgress(pct) {
            progressBar.style.width = pct + '%';
            progressText.textContent = Math.round(pct) + '%';
        }

        // Init
        if (speechSynthesis.onvoiceschanged) {
            speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
        }
        speechSynthesis.getVoices();
        updateVoiceSettings();
        
        console.log('ğŸŒ Web Lecture Vocal Multilingue - 10 langues actives');
    </script>
</body>
</html>
